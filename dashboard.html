<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bikroy Mobile Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background-color: #0f172a; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        /* Mobile Optimizations */
        .glass { background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="text-gray-200 min-h-screen flex flex-col pb-20">

    <!-- Mobile Header -->
    <nav class="glass sticky top-0 z-50 px-4 py-3 flex justify-between items-center shadow-lg">
        <h1 class="text-lg font-bold text-white tracking-wider"><span class="text-blue-500">BIKROY</span> CMD</h1>
        <div id="status-indicator" class="text-[10px] px-2 py-1 rounded bg-gray-800 text-gray-400 font-mono uppercase tracking-widest">
            OFFLINE
        </div>
    </nav>

    <main class="flex-1 p-4">
        <!-- Queue Stats (Horizontal Scroll for Mobile) -->
        <div id="mobile-queues" class="flex overflow-x-auto gap-2 mb-6 pb-2 no-scrollbar">
            <!-- Injected by JS -->
            <div class="text-gray-500 text-xs w-full text-center">Loading Queues...</div>
        </div>

        <!-- Controls -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button id="btn-start" class="col-span-2 bg-blue-600 active:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition flex items-center justify-center gap-2 text-lg">
                <i class="fas fa-play"></i> START TRACKING
            </button>
            <button id="btn-stop" class="bg-red-900/50 active:bg-red-800 text-red-200 py-3 rounded-xl border border-red-800 font-semibold">
                STOP
            </button>
            <button id="btn-refresh" class="bg-gray-700 active:bg-gray-600 text-white py-3 rounded-xl font-semibold">
                REFRESH
            </button>
        </div>

        <!-- Agents Grid -->
        <div id="agent-grid" class="grid grid-cols-1 gap-4">
            <!-- Injected by JS -->
        </div>
    </main>

    <!-- Mobile Bottom Sheet for Selection -->
    <div id="selector-sheet" class="fixed bottom-0 left-0 w-full bg-gray-900 rounded-t-2xl border-t border-gray-700 transform translate-y-full transition-transform duration-300 z-50 h-[70vh] flex flex-col">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center">
            <h3 class="font-bold text-white">Select Agents</h3>
            <button id="close-selector" class="text-gray-400 text-xl">&times;</button>
        </div>
        <div id="agent-list" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
        <div class="p-4 border-t border-gray-800">
            <button id="confirm-start" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">CONFIRM START</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // PASTE YOUR FIREBASE CONFIG HERE
        const firebaseConfig = {
            // ... paste content from firebase-config.js here ...
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        const agentsList = ["Mehedi", "Yeamin", "Utsow", "Udoy", "Salahuddin", "Halal", "Jisan", "Sarnali", "Asif", "Anik", "Riazul", "Sonjoy", "Roni"];

        const els = {
            status: document.getElementById('status-indicator'),
            queues: document.getElementById('mobile-queues'),
            grid: document.getElementById('agent-grid'),
            btnStart: document.getElementById('btn-start'),
            btnStop: document.getElementById('btn-stop'),
            btnRefresh: document.getElementById('btn-refresh'),
            sheet: document.getElementById('selector-sheet'),
            agentList: document.getElementById('agent-list'),
            closeSelector: document.getElementById('close-selector'),
            confirmStart: document.getElementById('confirm-start')
        };

        // --- 1. LISTEN TO DATA (READ ONLY) ---
        const statusRef = ref(db, 'status');
        onValue(statusRef, (snapshot) => {
            const data = snapshot.val();
            if(!data) return;

            // Update Status
            if(data.isRunning) {
                els.status.textContent = "ONLINE • TRACKING";
                els.status.className = "text-[10px] px-2 py-1 rounded bg-green-900 text-green-200 font-mono uppercase tracking-widest animate-pulse";
                els.btnStart.textContent = "TRACKING IN PROGRESS...";
                els.btnStart.disabled = true;
                els.btnStart.classList.add('opacity-50');
            } else {
                els.status.textContent = "ONLINE • IDLE";
                els.status.className = "text-[10px] px-2 py-1 rounded bg-gray-700 text-gray-300 font-mono uppercase tracking-widest";
                els.btnStart.innerHTML = '<i class="fas fa-play"></i> START TRACKING';
                els.btnStart.disabled = false;
                els.btnStart.classList.remove('opacity-50');
            }

            renderQueues(data.reviewCounts);
            renderAgents(data.agentData);
        });

        // --- 2. SEND COMMANDS (WRITE ONLY) ---
        
        els.btnStart.addEventListener('click', () => {
            els.sheet.classList.remove('translate-y-full');
            renderSelector();
        });

        els.closeSelector.addEventListener('click', () => {
            els.sheet.classList.add('translate-y-full');
        });

        els.confirmStart.addEventListener('click', () => {
            const selected = Array.from(document.querySelectorAll('.agent-cb:checked')).map(cb => cb.value);
            if(selected.length === 0) return alert("Select agent");
            
            // Send Command to Firebase
            set(ref(db, 'commands'), { action: 'start', payload: selected });
            els.sheet.classList.add('translate-y-full');
        });

        els.btnStop.addEventListener('click', () => {
            set(ref(db, 'commands'), { action: 'stop' });
        });

        els.btnRefresh.addEventListener('click', () => {
            set(ref(db, 'commands'), { action: 'refresh' });
        });

        // --- RENDERING HELPERS ---
        function renderQueues(counts) {
            if(!counts) return;
            els.queues.innerHTML = '';
            const keys = ['member', 'listing_fee', 'general', 'fraud', 'edited', 'verification'];
             const labels = { 'member': 'MEM', 'listing_fee': 'LIST', 'general': 'GEN', 'fraud': 'FRD', 'edited': 'EDIT', 'verification': 'VER' };
            
            keys.forEach(k => {
                if(counts[k] !== undefined) {
                    const isHigh = counts[k] > 50;
                    const div = document.createElement('div');
                    div.className = `flex-shrink-0 w-20 h-16 rounded-lg flex flex-col items-center justify-center border ${isHigh ? 'bg-red-900/40 border-red-500' : 'bg-gray-800 border-gray-700'}`;
                    div.innerHTML = `<span class="text-[10px] text-gray-400 font-bold">${labels[k]}</span><span class="text-xl font-bold text-white">${counts[k]}</span>`;
                    els.queues.appendChild(div);
                }
            });
        }

        function renderAgents(data) {
            if(!data) return;
            els.grid.innerHTML = '';
            Object.keys(data).sort().forEach(name => {
                const agent = data[name];
                const card = document.createElement('div');
                card.className = "bg-gray-800 rounded-xl p-4 border border-gray-700";
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-bold text-white">${name}</h3>
                        <span class="text-xs bg-gray-900 px-2 py-1 rounded text-purple-400 border border-gray-700">${agent.permissions || '-'}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="text-center bg-gray-900/50 rounded p-2">
                            <div class="text-xl font-bold text-blue-400">${agent.thisHourAds || 0}</div>
                            <div class="text-[8px] uppercase text-gray-500">Hr</div>
                        </div>
                        <div class="text-center bg-gray-900/50 rounded p-2">
                             <div class="text-xl font-bold text-purple-400">${agent.lastHourAds || 0}</div>
                            <div class="text-[8px] uppercase text-gray-500">Last</div>
                        </div>
                        <div class="text-center bg-gray-900/50 rounded p-2">
                             <div class="text-xl font-bold text-green-400">${agent.cumulativeNewAds || 0}</div>
                            <div class="text-[8px] uppercase text-gray-500">Total</div>
                        </div>
                    </div>
                `;
                els.grid.appendChild(card);
            });
        }

        function renderSelector() {
            els.agentList.innerHTML = agentsList.map(name => `
                <label class="flex items-center space-x-4 p-3 rounded-lg bg-gray-800 active:bg-gray-700">
                    <input type="checkbox" value="${name}" class="agent-cb w-5 h-5 accent-blue-600">
                    <span class="text-white font-medium">${name}</span>
                </label>
            `).join('');
        }
    </script>
</body>
</html>
